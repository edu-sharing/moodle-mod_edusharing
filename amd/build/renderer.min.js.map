{"version":3,"file":"renderer.min.js","sources":["../src/renderer.js"],"sourcesContent":["import Config from 'core/config';\nimport {getCurrentUser, getSecuredNode, sendXapiStatement} from \"./repository\";\n\nexport const init = async(repoUrl, contextId) => {\n    const element = document.getElementById('edusharing_view');\n    window.addEventListener('message', async(e) => {\n        if (!e.data || e.data.type !== 'H5P_XAPI') {\n            return;\n        }\n        const statement = e.data.statement;\n        const moodleUser = await getCurrentUser().catch(error => {\n            window.console.error(error);\n        });\n        statement.actor.mbox = `mailto:${moodleUser.email}`;\n        const originalId = statement?.object?.id;\n        const originalUrl = new URL(originalId, window.location.href);\n        const subContentId = originalUrl.searchParams.get('subContentId');\n        const customUrl = new URL(`${Config.wwwroot}/mod/edusharing/xapi`);\n        customUrl.searchParams.set('id', String(contextId));\n        if (subContentId) {\n            customUrl.searchParams.set('subContentId', subContentId);\n        }\n        statement.object.id = customUrl.toString();\n        const ajaxParams = {\n            component: 'mod_edusharing',\n            requestjson: JSON.stringify(statement)\n        };\n        sendXapiStatement(ajaxParams);\n    });\n    await renderObject(element, repoUrl);\n};\n\n/**\n * @param {Element} element\n * @param {string} repoUrl\n */\nexport const renderObject = async(element, repoUrl) => {\n    const wrapper = element.parentElement;\n    if (!wrapper) {\n        return;\n    }\n    const width = element.getAttribute('data-width');\n    const nodeId = element.getAttribute('data-node');\n    const containerId = element.getAttribute('data-container');\n    const version = element.getAttribute('data-version');\n    const usage = element.getAttribute('data-usage');\n    const resourceId = element.getAttribute('data-resource');\n\n    const resourceUrl = `${Config.wwwroot}/mod/edusharing/contentRedirect.php?` +\n        `nodeId=${nodeId}&nodeVersion=${version}&usageId=${usage}&resourceId=${resourceId}&containerId=${containerId}`;\n\n    const ajaxParams = {\n        eduSecuredNodeStructure: {\n            nodeId: nodeId,\n            resourceId: resourceId,\n            version: version,\n        }\n    };\n\n    const response = await getSecuredNode(ajaxParams).catch(error => {\n        window.console.error(error);\n    });\n\n    const customWidth = response.customWidth;\n    if (customWidth) {\n        if (customWidth !== 'none') {\n            wrapper.style.width = customWidth;\n        }\n    } else {\n        wrapper.style.width = width ? (width + \"px\") : '';\n    }\n    const moodleUser = await getCurrentUser().catch(error => {\n        window.console.error(error);\n    });\n\n    const eduUser = {\n        authorityName: moodleUser.username,\n        firstName: moodleUser.firstname,\n        surName: moodleUser.lastname,\n        userEMail: moodleUser.email\n    };\n    const serviceWorkerPhp = `${Config.wwwroot}/mod/edusharing/getServiceWorker.php`;\n    if ('serviceWorker' in navigator) {\n        await navigator.serviceWorker.register(serviceWorkerPhp, {\n            scope: '/'\n        });\n        await navigator.serviceWorker.ready;\n    }\n\n    const renderComponent = document.createElement('edu-sharing-render');\n    renderComponent.classList.add('edu-sharing-render');\n    renderComponent.encoded_node = response.securedNode;\n    renderComponent.signature = response.signature;\n    renderComponent.jwt = response.jwt;\n    renderComponent.render_url = response.renderingBaseUrl;\n    renderComponent.encoded_user = btoa(JSON.stringify(eduUser));\n    renderComponent.service_worker_url = serviceWorkerPhp;\n    renderComponent.activate_service_worker = false;\n    renderComponent.assets_url = repoUrl + '/web-components/rendering-service-amd/assets';\n    renderComponent.resource_url = resourceUrl;\n    renderComponent.preview_url = response.previewUrl;\n    wrapper.innerHTML = \"\";\n    wrapper.appendChild(renderComponent);\n};\n"],"names":["async","repoUrl","contextId","element","document","getElementById","window","addEventListener","e","data","type","statement","moodleUser","catch","error","console","actor","mbox","email","originalId","object","_statement$object","id","subContentId","URL","location","href","searchParams","get","customUrl","Config","wwwroot","set","String","toString","ajaxParams","component","requestjson","JSON","stringify","renderObject","wrapper","parentElement","width","getAttribute","nodeId","containerId","version","usage","resourceId","resourceUrl","eduSecuredNodeStructure","response","customWidth","style","eduUser","authorityName","username","firstName","firstname","surName","lastname","userEMail","serviceWorkerPhp","navigator","serviceWorker","register","scope","ready","renderComponent","createElement","classList","add","encoded_node","securedNode","signature","jwt","render_url","renderingBaseUrl","encoded_user","btoa","service_worker_url","activate_service_worker","assets_url","resource_url","preview_url","previewUrl","innerHTML","appendChild"],"mappings":"mSAGoBA,MAAMC,QAASC,mBACzBC,QAAUC,SAASC,eAAe,mBACxCC,OAAOC,iBAAiB,WAAWP,MAAAA,8BAC1BQ,EAAEC,MAAwB,aAAhBD,EAAEC,KAAKC,kBAGhBC,UAAYH,EAAEC,KAAKE,UACnBC,iBAAmB,gCAAiBC,OAAMC,QAC5CR,OAAOS,QAAQD,MAAMA,UAEzBH,UAAUK,MAAMC,sBAAiBL,WAAWM,aACtCC,WAAaR,MAAAA,qCAAAA,UAAWS,2CAAXC,kBAAmBC,GAEhCC,aADc,IAAIC,IAAIL,WAAYb,OAAOmB,SAASC,MACvBC,aAAaC,IAAI,gBAC5CC,UAAY,IAAIL,cAAOM,gBAAOC,iCACpCF,UAAUF,aAAaK,IAAI,KAAMC,OAAO/B,YACpCqB,cACAM,UAAUF,aAAaK,IAAI,eAAgBT,cAE/CZ,UAAUS,OAAOE,GAAKO,UAAUK,iBAC1BC,WAAa,CACfC,UAAW,iBACXC,YAAaC,KAAKC,UAAU5B,8CAEdwB,qBAEhBK,aAAarC,QAASF,gBAOnBuC,aAAexC,MAAMG,QAASF,iBACjCwC,QAAUtC,QAAQuC,kBACnBD,qBAGCE,MAAQxC,QAAQyC,aAAa,cAC7BC,OAAS1C,QAAQyC,aAAa,aAC9BE,YAAc3C,QAAQyC,aAAa,kBACnCG,QAAU5C,QAAQyC,aAAa,gBAC/BI,MAAQ7C,QAAQyC,aAAa,cAC7BK,WAAa9C,QAAQyC,aAAa,iBAElCM,YAAc,UAAGpB,gBAAOC,iEAChBc,+BAAsBE,4BAAmBC,6BAAoBC,mCAA0BH,aAE/FX,WAAa,CACfgB,wBAAyB,CACrBN,OAAQA,OACRI,WAAYA,WACZF,QAASA,UAIXK,eAAiB,8BAAejB,YAAYtB,OAAMC,QACpDR,OAAOS,QAAQD,MAAMA,UAGnBuC,YAAcD,SAASC,YACzBA,YACoB,SAAhBA,cACAZ,QAAQa,MAAMX,MAAQU,aAG1BZ,QAAQa,MAAMX,MAAQA,MAASA,MAAQ,KAAQ,SAE7C/B,iBAAmB,gCAAiBC,OAAMC,QAC5CR,OAAOS,QAAQD,MAAMA,UAGnByC,QAAU,CACZC,cAAe5C,WAAW6C,SAC1BC,UAAW9C,WAAW+C,UACtBC,QAAShD,WAAWiD,SACpBC,UAAWlD,WAAWM,OAEpB6C,2BAAsBjC,gBAAOC,gDAC/B,kBAAmBiC,kBACbA,UAAUC,cAAcC,SAASH,iBAAkB,CACrDI,MAAO,YAELH,UAAUC,cAAcG,aAG5BC,gBAAkBjE,SAASkE,cAAc,sBAC/CD,gBAAgBE,UAAUC,IAAI,sBAC9BH,gBAAgBI,aAAerB,SAASsB,YACxCL,gBAAgBM,UAAYvB,SAASuB,UACrCN,gBAAgBO,IAAMxB,SAASwB,IAC/BP,gBAAgBQ,WAAazB,SAAS0B,iBACtCT,gBAAgBU,aAAeC,KAAK1C,KAAKC,UAAUgB,UACnDc,gBAAgBY,mBAAqBlB,iBACrCM,gBAAgBa,yBAA0B,EAC1Cb,gBAAgBc,WAAalF,QAAU,+CACvCoE,gBAAgBe,aAAelC,YAC/BmB,gBAAgBgB,YAAcjC,SAASkC,WACvC7C,QAAQ8C,UAAY,GACpB9C,QAAQ+C,YAAYnB"}
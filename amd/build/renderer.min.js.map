{"version":3,"file":"renderer.min.js","sources":["../src/renderer.js"],"sourcesContent":["import Config from 'core/config';\nimport {getCurrentUser, getSecuredNode, sendXapiStatement} from \"./repository\";\n\nexport const init = async(repoUrl) => {\n    const element = document.getElementById('edusharing_view');\n    window.addEventListener('message', async(e) => {\n        if (!e.data || e.data.type !== 'H5P_XAPI') {\n            return;\n        }\n        const moodleUser = await getCurrentUser().catch(error => {\n            window.console.error(error);\n        });\n        const statement = e.data.statement;\n        window.console.log(\"statement:\");\n        window.console.log(statement);\n        statement.object.id = window.location.href;\n        statement.actor.mbox = `mailto:${moodleUser.email}`;\n        window.console.log(\"statement after:\");\n        window.console.log(statement);\n        const ajaxParams = {\n            component: 'mod_edusharing',\n            requestjson: JSON.stringify(statement)\n        };\n        sendXapiStatement(ajaxParams);\n    });\n    await renderObject(element, repoUrl);\n};\n\n/**\n * @param {Element} element\n * @param {string} repoUrl\n */\nexport const renderObject = async(element, repoUrl) => {\n    const wrapper = element.parentElement;\n    if (!wrapper) {\n        return;\n    }\n    const width = element.getAttribute('data-width');\n    const nodeId = element.getAttribute('data-node');\n    const containerId = element.getAttribute('data-container');\n    const version = element.getAttribute('data-version');\n    const usage = element.getAttribute('data-usage');\n    const resourceId = element.getAttribute('data-resource');\n\n    const resourceUrl = `${Config.wwwroot}/mod/edusharing/contentRedirect.php?` +\n        `nodeId=${nodeId}&nodeVersion=${version}&usageId=${usage}&resourceId=${resourceId}&containerId=${containerId}`;\n\n    const ajaxParams = {\n        eduSecuredNodeStructure: {\n            nodeId: nodeId,\n            resourceId: resourceId,\n            version: version,\n        }\n    };\n\n    const response = await getSecuredNode(ajaxParams).catch(error => {\n        window.console.error(error);\n    });\n\n    const customWidth = response.customWidth;\n    if (customWidth) {\n        if (customWidth !== 'none') {\n            wrapper.style.width = customWidth;\n        }\n    } else {\n        wrapper.style.width = width ? (width + \"px\") : '';\n    }\n    const moodleUser = await getCurrentUser().catch(error => {\n        window.console.error(error);\n    });\n\n    const eduUser = {\n        authorityName: moodleUser.username,\n        firstName: moodleUser.firstname,\n        surName: moodleUser.lastname,\n        userEMail: moodleUser.email\n    };\n    const serviceWorkerPhp = `${Config.wwwroot}/mod/edusharing/getServiceWorker.php`;\n    if ('serviceWorker' in navigator) {\n        await navigator.serviceWorker.register(serviceWorkerPhp, {\n            scope: '/'\n        });\n        await navigator.serviceWorker.ready;\n    }\n\n    const renderComponent = document.createElement('edu-sharing-render');\n    renderComponent.classList.add('edu-sharing-render');\n    renderComponent.encoded_node = response.securedNode;\n    renderComponent.signature = response.signature;\n    renderComponent.jwt = response.jwt;\n    renderComponent.render_url = response.renderingBaseUrl;\n    renderComponent.encoded_user = btoa(JSON.stringify(eduUser));\n    renderComponent.service_worker_url = serviceWorkerPhp;\n    renderComponent.activate_service_worker = false;\n    renderComponent.assets_url = repoUrl + '/web-components/rendering-service-amd/assets';\n    renderComponent.resource_url = resourceUrl;\n    renderComponent.preview_url = response.previewUrl;\n    wrapper.innerHTML = \"\";\n    wrapper.appendChild(renderComponent);\n};\n"],"names":["async","element","document","getElementById","window","addEventListener","e","data","type","moodleUser","catch","error","console","statement","log","object","id","location","href","actor","mbox","email","ajaxParams","component","requestjson","JSON","stringify","renderObject","repoUrl","wrapper","parentElement","width","getAttribute","nodeId","containerId","version","usage","resourceId","resourceUrl","Config","wwwroot","eduSecuredNodeStructure","response","customWidth","style","eduUser","authorityName","username","firstName","firstname","surName","lastname","userEMail","serviceWorkerPhp","navigator","serviceWorker","register","scope","ready","renderComponent","createElement","classList","add","encoded_node","securedNode","signature","jwt","render_url","renderingBaseUrl","encoded_user","btoa","service_worker_url","activate_service_worker","assets_url","resource_url","preview_url","previewUrl","innerHTML","appendChild"],"mappings":"mSAGoBA,MAAAA,gBACVC,QAAUC,SAASC,eAAe,mBACxCC,OAAOC,iBAAiB,WAAWL,MAAAA,QAC1BM,EAAEC,MAAwB,aAAhBD,EAAEC,KAAKC,kBAGhBC,iBAAmB,gCAAiBC,OAAMC,QAC5CP,OAAOQ,QAAQD,MAAMA,UAEnBE,UAAYP,EAAEC,KAAKM,UACzBT,OAAOQ,QAAQE,IAAI,cACnBV,OAAOQ,QAAQE,IAAID,WACnBA,UAAUE,OAAOC,GAAKZ,OAAOa,SAASC,KACtCL,UAAUM,MAAMC,sBAAiBX,WAAWY,OAC5CjB,OAAOQ,QAAQE,IAAI,oBACnBV,OAAOQ,QAAQE,IAAID,iBACbS,WAAa,CACfC,UAAW,iBACXC,YAAaC,KAAKC,UAAUb,8CAEdS,qBAEhBK,aAAa1B,QAAS2B,gBAOnBD,aAAe3B,MAAMC,QAAS2B,iBACjCC,QAAU5B,QAAQ6B,kBACnBD,qBAGCE,MAAQ9B,QAAQ+B,aAAa,cAC7BC,OAAShC,QAAQ+B,aAAa,aAC9BE,YAAcjC,QAAQ+B,aAAa,kBACnCG,QAAUlC,QAAQ+B,aAAa,gBAC/BI,MAAQnC,QAAQ+B,aAAa,cAC7BK,WAAapC,QAAQ+B,aAAa,iBAElCM,YAAc,UAAGC,gBAAOC,iEAChBP,+BAAsBE,4BAAmBC,6BAAoBC,mCAA0BH,aAE/FZ,WAAa,CACfmB,wBAAyB,CACrBR,OAAQA,OACRI,WAAYA,WACZF,QAASA,UAIXO,eAAiB,8BAAepB,YAAYZ,OAAMC,QACpDP,OAAOQ,QAAQD,MAAMA,UAGnBgC,YAAcD,SAASC,YACzBA,YACoB,SAAhBA,cACAd,QAAQe,MAAMb,MAAQY,aAG1Bd,QAAQe,MAAMb,MAAQA,MAASA,MAAQ,KAAQ,SAE7CtB,iBAAmB,gCAAiBC,OAAMC,QAC5CP,OAAOQ,QAAQD,MAAMA,UAGnBkC,QAAU,CACZC,cAAerC,WAAWsC,SAC1BC,UAAWvC,WAAWwC,UACtBC,QAASzC,WAAW0C,SACpBC,UAAW3C,WAAWY,OAEpBgC,2BAAsBd,gBAAOC,gDAC/B,kBAAmBc,kBACbA,UAAUC,cAAcC,SAASH,iBAAkB,CACrDI,MAAO,YAELH,UAAUC,cAAcG,aAG5BC,gBAAkBzD,SAAS0D,cAAc,sBAC/CD,gBAAgBE,UAAUC,IAAI,sBAC9BH,gBAAgBI,aAAerB,SAASsB,YACxCL,gBAAgBM,UAAYvB,SAASuB,UACrCN,gBAAgBO,IAAMxB,SAASwB,IAC/BP,gBAAgBQ,WAAazB,SAAS0B,iBACtCT,gBAAgBU,aAAeC,KAAK7C,KAAKC,UAAUmB,UACnDc,gBAAgBY,mBAAqBlB,iBACrCM,gBAAgBa,yBAA0B,EAC1Cb,gBAAgBc,WAAa7C,QAAU,+CACvC+B,gBAAgBe,aAAepC,YAC/BqB,gBAAgBgB,YAAcjC,SAASkC,WACvC/C,QAAQgD,UAAY,GACpBhD,QAAQiD,YAAYnB"}